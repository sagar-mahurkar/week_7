name: CD - Deploy FastAPI to GKE

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GAR_LOCATION: us-central1                    # Artifact Registry region
  REPOSITORY: ${{ secrets.GAR_REPO }}         # GAR repo (dynamic)
  IMAGE: iris-api                             
  CLUSTER_NAME: ${{ secrets.GKE_CLUSTER }}    
  CLUSTER_LOCATION: ${{ secrets.GKE_LOCATION }}
  DEPLOYMENT_NAME: iris-workload-deployment
  NAMESPACE: default

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:

      # -------------------------------------------------------------
      # 1. Checkout Repo
      # -------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # -------------------------------------------------------------
      # 2. Authenticate to GCP
      # -------------------------------------------------------------
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS_JSON }}

      # -------------------------------------------------------------
      # 3. Initialize gcloud
      # -------------------------------------------------------------
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          export_default_credentials: true

      # -------------------------------------------------------------
      # 4. Install GKE auth plugin
      # -------------------------------------------------------------
      - name: Install GKE Auth Plugin
        run: gcloud components install gke-gcloud-auth-plugin --quiet

      # -------------------------------------------------------------
      # 5. Ensure Artifact Registry Repository Exists
      # -------------------------------------------------------------
      - name: Create Artifact Registry repository if missing
        run: |
          echo "üîç Checking if GAR repo '${REPOSITORY}' exists in region '${GAR_LOCATION}'..."

          if gcloud artifacts repositories describe "${REPOSITORY}" \
            --location="${GAR_LOCATION}" \
            --project="${PROJECT_ID}" >/dev/null 2>&1; then

            echo "‚úÖ Repository '${REPOSITORY}' already exists."

          else
            echo "‚ö†Ô∏è Repository '${REPOSITORY}' does not exist. Creating..."
            gcloud artifacts repositories create "${REPOSITORY}" \
              --repository-format=docker \
              --location="${GAR_LOCATION}" \
              --description="Docker repo for FastAPI deployment" \
              --project="${PROJECT_ID}"
            echo "üéâ Repository created successfully!"
          fi

      # -------------------------------------------------------------
      # 6. Configure Docker for GAR
      # -------------------------------------------------------------
      - name: Configure Docker
        run: gcloud auth configure-docker "${GAR_LOCATION}-docker.pkg.dev" --quiet

      # -------------------------------------------------------------
      # 7. Build Docker image
      # -------------------------------------------------------------
      - name: Build Docker Image
        run: |
          IMAGE_URI="${GAR_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${IMAGE}:latest"
          echo "üì¶ Building image: $IMAGE_URI"
          docker build -t "$IMAGE_URI" .

      # -------------------------------------------------------------
      # 8. Push Docker image to GAR
      # -------------------------------------------------------------
      - name: Push Docker Image
        run: |
          IMAGE_URI="${GAR_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${IMAGE}:latest"
          echo "üöÄ Pushing image: $IMAGE_URI"
          docker push "$IMAGE_URI"

      # -------------------------------------------------------------
      # 9. Get GKE Cluster Credentials
      # -------------------------------------------------------------
      - name: Fetch GKE Credentials
        run: |
          echo "üîç Getting GKE credentials..."

          # Try region first ‚Üí fallback to zone
          if ! gcloud container clusters get-credentials "${CLUSTER_NAME}" \
              --region "${CLUSTER_LOCATION}" \
              --project "${PROJECT_ID}"; then
            
            echo "‚ö†Ô∏è Region lookup failed, trying zone..."
            gcloud container clusters get-credentials "${CLUSTER_NAME}" \
              --zone "${CLUSTER_LOCATION}" \
              --project "${PROJECT_ID}"
          fi

          echo "‚úÖ Connected to cluster:"
          kubectl config current-context

      # -------------------------------------------------------------
      # 10. Apply Kubernetes Manifests
      # -------------------------------------------------------------
      - name: Apply Kubernetes manifests
        run: |
          echo "üìÑ Applying manifests from k8s/"
          kubectl apply -f k8s/ -n "${NAMESPACE}"

      # -------------------------------------------------------------
      # 11. Update Deployment image (Rolling Update)
      # -------------------------------------------------------------
      - name: Update Deployment Image
        run: |
          IMAGE_URI="${GAR_LOCATION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${IMAGE}:latest"

          echo "üîÑ Updating Deployment: ${DEPLOYMENT_NAME}"
          echo "üëâ New image: ${IMAGE_URI}"

          CONTAINER_NAME=$(kubectl get deployment "${DEPLOYMENT_NAME}" \
            -n "${NAMESPACE}" \
            -o jsonpath='{.spec.template.spec.containers[0].name}')

          echo "üì¶ Target container: ${CONTAINER_NAME}"

          kubectl set image deployment/${DEPLOYMENT_NAME} \
            ${CONTAINER_NAME}=${IMAGE_URI} -n "${NAMESPACE}"

          echo "‚è≥ Waiting for rollout..."
          kubectl rollout status deployment/${DEPLOYMENT_NAME} \
            -n "${NAMESPACE}" --timeout=5m

          echo "‚úÖ Deployment updated."

      # -------------------------------------------------------------
      # 12. Verify Pods
      # -------------------------------------------------------------
      - name: Verify Pods
        run: |
          echo "üîç Listing pods..."
          kubectl get pods -n "${NAMESPACE}" -o wide
